package com.smartcity.vehicletracking.service;

import com.smartcity.vehicletracking.dto.TelemetryRequest;
import com.smartcity.vehicletracking.model.*;
import com.smartcity.vehicletracking.repository.*;
import org.springframework.stereotype.Service;
import java.time.LocalDateTime;

@Service
public class VehicleTrackingService {

    private final VehicleRepository vehicleRepository;
    private final VehicleStatusRepository vehicleStatusRepository;
    private final VehiclePositionRepository vehiclePositionRepository;

    public VehicleTrackingService(VehicleRepository vehicleRepository,
                                  VehicleStatusRepository vehicleStatusRepository,
                                  VehiclePositionRepository vehiclePositionRepository) {
        this.vehicleRepository = vehicleRepository;
        this.vehicleStatusRepository = vehicleStatusRepository;
        this.vehiclePositionRepository = vehiclePositionRepository;
    }

    public void processTelemetry(TelemetryRequest request) {
        Vehicle vehicle = new Vehicle();
        vehicle.setId(request.getTelemetryId());

        VehicleStatus status = new VehicleStatus();
        status.setStatus("ACTIVE");
        status.setDetails("Telemetry received");
        vehicle.setStatus(status);

        vehicleStatusRepository.save(status);
        vehicleRepository.save(vehicle);

        VehiclePosition position = new VehiclePosition();
        position.setLat(request.getLat());
        position.setLon(request.getLon());
        position.setTimestamp(request.getTimestamp());
        position.setVehicle(vehicle);

        vehiclePositionRepository.save(position);
    }
}
