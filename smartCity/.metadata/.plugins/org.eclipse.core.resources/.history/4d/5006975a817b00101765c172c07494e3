package com.smartcity.vehicletracking.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.smartcity.vehicletracking.dto.TelemetryRequest;
import com.smartcity.vehicletracking.model.Vehicle;
import com.smartcity.vehicletracking.model.VehiclePosition;
import com.smartcity.vehicletracking.model.VehicleStatus;
import com.smartcity.vehicletracking.repository.VehiclePositionRepository;
import com.smartcity.vehicletracking.repository.VehicleRepository;
import com.smartcity.vehicletracking.repository.VehicleStatusRepository;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class VehicleTrackingService {

    private final VehicleRepository vehicleRepository;
    private final VehiclePositionRepository positionRepository;
    private final VehicleStatusRepository statusRepository;

    @Autowired
    public VehicleTrackingService(
            VehicleRepository vehicleRepository,
            VehiclePositionRepository positionRepository,
            VehicleStatusRepository statusRepository) {
        this.vehicleRepository = vehicleRepository;
        this.positionRepository = positionRepository;
        this.statusRepository = statusRepository;
    }
    public VehiclePosition processTelemetry(TelemetryRequest req) {
        // Find vehicle
        Vehicle vehicle = vehicleRepository.findById(req.getTelemetryId())
                .orElseGet(() -> {
                    Vehicle newVehicle = Vehicle.builder().id(req.getTelemetryId()).build();
                    return vehicleRepository.save(newVehicle);
                });

        // Create new position
        VehiclePosition position = VehiclePosition.builder()
                .vehicle(vehicle)
                .lat(req.getLat())
                .lon(req.getLon())
                .timestamp(req.getTimestamp())
                .build();
        positionRepository.save(position);

        // Update status
        VehicleStatus status = VehicleStatus.builder()
                .status("ACTIVE")
                .details("Telemetry received at " + req.getTimestamp())
                .build();
        statusRepository.save(status);

        vehicle.setStatus(status);
        vehicleRepository.save(vehicle);

        return position;
    }
}
